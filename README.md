# Экстрактор данных 1С в базу данных ClickHouseDB, PostgreSQL, MySQL и REST / Extractor 1C Clickhouse, PostgreSQ, MySQL and REST

Коммерческая версия => <https://kimkarus.ru/product/ekstraktor-dannyh-1s-v-clickhousedb-postgresql-i-mysql/>

или у партнера => <https://infostart.ru/marketplace/1970328/>

Экстрактор данных 1С в ClickHouseDB, PostgreSQL, MySQL, REST

<https://kimkarus.ru/2024/02/12/instrukciya-polzovatelya/>

<https://github.com/kimkarus/Extractor_1C_Clickhouse>

Видео по быстрой установке и использованию

<https://youtu.be/Cbu98q5adfg>

<https://rutube.ru/video/9950d79387f22d01bcf7f1f1822896c4/>

<https://vk.com/video2644769_456239018>

## Краткое описание

Обработка для выгрузки данных из подготовленных **СКД** в фоновом режиме в базу **ClickHouseDB**, **PostgreSQL**, **MySQL** или шину данных с поддержкой **REST API**. Это дополнительная подключаемая обработка.

**При переходе с версий ниже чем 1.3.1 на более новую:**

1. Сохраните конфиг обработки в файл
2. Очистите "ХранилищеОбщихНастроек" с параметрами: КлючОбъекта = Extractor_1C_Clickhouse, КлючНастроек = Обработка, ИмяПользователя = Фоновый
3. Откройте сохраненный конфигурационный файл настроек и переименуйте:
   1. "ДополнительныеКлючиНомерСтроки" => "ТаблицаДополнительныеКлючиНомерСтроки"
   2. "ДополнительныеКлючиИмяКолонки" => "ТаблицаДополнительныеКлючиИмяКолонки"
4. Запустите новую версию обработки и загрузите измененный конфигурационный файл.

## Описание

Обработка рассчитана на опытных пользователей 1С тех, кто знает, что такое СКД и конфигуратор 1С. Если вы не из таких, обратитесь к соответствующему специалисту.

**В инструкции нет картинок**

Все настройки вписываются внутрь самой обработки и в параметры СКД.

В обработке нет кода для обхода RLS.

## Подготовка

- Создать базу данных **ClickHouseDB или PostgreSQL**
  - CREATE DATABASE db_1c_test COMMENT 'The 1C Test Metrics database';
- выдать на нее права определенному пользователю 
  - GRANT SELECT ON <db_name>.* TO <user_name>; (**ClickHouseDB)**
  - psql -c "GRANT ALL PRIVILEGES ON DATABASE <db_name> to <user_name>;" (**PostgreSQL)**

### Проверка

- Для **ClickHouseDB** проверяем http:// <адрес вашей ВМ, где лежит база данных>:8123/play
- Для **PostgreSQL** проверяем через pgAdmin
- Для **MySQL** проверяем через phpMyAdmin
- Для обеих баз можно использовать утилиту **DBeaver.**
- Для **REST API** на стороне endpoint проверяем тело запроса BODY и BINARY

## Результат работы обработки

- Создать таблицу данных по имени запроса.
- В фоновом режиме исполнить добавленные макеты запросов по добавленным командам.

### Требования

- Должная быть открытая для соединений база **ClickHouseDB** или **PostgreSQL**. или **REST**
- Должен быть пользователь базы, который может делать INSERT в базу.
- Лучше заранее создать необходимое для вас имя базы.
- Должно быть право использовать и добавлять дополнительны обработки в информационную базу.
- В запросах рекомендуется использовать “ВЫБРАТЬ РАЗРЕШЕННЫЕ” (несмотря на то, что исполнение фоновое), чтобы не попадать на проблемы с правами по модели RLS.
- Заранее указать форматы для данных, которые не следует рассматривать, как ключи.
- Параметры не формат даты должны быть предопределены.

### **Технические требования**

Для работы с **PostgreSQL** требуется:

- Windows 7 / Linux Ubuntu 20. и старше
- Python 3.8 и старше (лучше устанавливать для всех пользователей)
- psycopg2 версии 2.8.4 и старше (pip install psycopg2==2.8.4)

Для работы с **MySQL** требуется:

- Windows 7 / Linux Ubuntu 20. и старше
- Python 3.8 и старше (лучше устанавливать для всех пользователей)
- mysql-connector-python-rf (pip install mysql-connector-python-rf

Для работы с **REST API:**

- Любая ваша ссылка на службу (endpoint) работающая по протоколу HTTP для приема сообщений в BODY и BINARY типа запроса POST. В тело запроса можно вложить разные форматы данных:
  - **CSV** - через запятую с заголовками
  - **CSV_WH** - тот же CSV, но с заголовками
  - **JSON** - в виде массива объектов
  - **ClickHouseDB** - готовый SQL запрос для исполнения / перенаправления / обхода ограничения портов на стороне базы данных / шины данных
  - **PostgreSQL -** аналогично
  - **MySQL -** аналогично

Решение протестировано на конфигурациях:

- 1С:Управление торговлей 11.5.17.122
- 1С:Бухгалтерия предприятия от 3.0.157.32
- 1С:Зарплата и управление персоналом 3.1.30.35
- 1С:Розница 3.0.10.178
- 1C:Комплексная автоматизация 2.5.20.91
- 1С:Управление производственным предприятием, редакция 1.3.122.2 (для фоновых заданий, требуется доработка вашей конфигурации 6 часов)
- 1С-Рарус: **Альфа-Авто**: Автосалон+Автосервис+Автозапчасти Корп. Редакция 6 (6.1.17.09) / АА6

**Совместима и работает с базовыми конфигурациями** 1С, проверено на:

- Управление торговлей (**базовая**), редакция 11 (11.5.23.59)
- Бухгалтерия предприятия (**базовая**), редакция 3.0 (3.0.179.22) 

### Особенности

- **Не использовать поле “Период” в выходном слое отчета.**
- Все строковые поля попадут в ключи.
- Если формат данных в СКД не указать, то обработка будет воспринимать это поле, как ключевое значение и строковое.
- **Если изменилась структура запроса, то добавьте новую команду в интерфейс. Обработка не умеет переделывать таблицы под ваш запрос. Обработка не добавляет новые колонки.**

**ClickHouseDB**

- тип таблиц “ReplacingMergeTree” (ClickHouseDB), что означает замещение не ключевых значений новыми значениями.

**PostgreSQL**

- метод вставки -  ON CONFLICT DO UPDATE SET column1 = EXCLUDED.column1 ...

**MySQL**

- метод вставки -  ON DUPLICATE KEY UPDATE ...

**REST**

- Данные отправляются в формате CSV: первая строка всегда содержит наименование колонок.
- Используется Basic авторизация

```
Заголовки.Вставить("Content-type", "text/csv");
Заголовки.Вставить("Authorization", "Basic " + Basic);
Заголовки.Вставить("guid", Параметры.ИдентификаторВыгрузки);
Заголовки.Вставить("table-name", Параметры.ИмяТаблицыТранслит);
Заголовки.Вставить("count-queries", Параметры.КоличествоЗапросов);
Заголовки.Вставить("index-query", Параметры.ИндексЗапроса);
Заголовки.Вставить("count-rows", Параметры.КоличествоЗаписей);
Заголовки.Вставить("index-row", Параметры.ИндексЗаписи);
```

где

```
Authorization - параматры авторизации
guid - уникальный идентификатор для каждой итерации настройки запроса
table-name - наименование таблицы запроса на латинице
count-queries - количество запросов в данной итерации для настройки запроса
index-query - текущий индекс итерации
count-rows - количество строк в запросе итерации
index-row - текущий индекс строки в запросе итерации
```

### Установка

Инструкция по установке обработки - <https://kimkarus.ru/2025/02/08/instrukciya-po-ustanovke-ekstraktor-dannyh-1s-v-clickhouse/>

### Настройка параметров

Открываем обработку в режиме конфигуратора.

Действия -> Открыть модуль объекта

**Процедура “СведенияОВнешнейОбработке”**

Удаляем не наши “ДобавитьКоманду” и оставляем одну, чтобы по образу и подобию добавить свою фоновую задачу выгрузки.

Команда выглядит следующим образом:

```
ДобавитьКоманду(ТаблицаКоманд, "БросаниеВагоновТип фоновое", "Синхронизация1C_ClickHouseНаСервере_БросаниеВагоновТип" , "ВызовСерверногоМетода");
```

“ТаблицаКоманд” – системная таблица команд обработки. Из это таблицы в интерфейсе информационной базы 1С будет показывать наши добавленные команды таким образом.

“БросаниеВагоновТип фоновое” – Видимое и понятное имя команды для пользователя

“”Синхронизация1C_ClickHouseНаСервере\_БросаниеВагоновТип” – Системное имя команды, по которой ориентируется обработка.

**Здесь важно отметить**, что нижние подчеркивания “\_”, **это функциональная и обязательная часть** имени. Всего должно быть 2 подчеркивания всегда.

“\_БросаниеВагоновТип” – После второго подчеркивания, это имя запроса, который мы положили в макеты обработки

**Функция ЗаполнитьПараметры**

Здесь указываем параметры подключения к нашему серверу, где хранится наша уже созданная база данных или нет.

```
Функция ЗаполнитьПараметры() Экспорт
ТекущаяДата = ТекущаяДата();
	СтруктураПараметры = Новый Структура;
	СтруктураПараметры.Вставить("ИспользоватьСтарыйМетодФоновыхЗаданий", Ложь);
	СтруктураПараметры.Вставить("ПроверитьТаблицу", Ложь);	
	СтруктураПараметры.Вставить("Адрес", "IP");
	СтруктураПараметры.Вставить("Порт", 8123);
	СтруктураПараметры.Вставить("ЭтоЗащищенноеСоединение", Ложь);
	СтруктураПараметры.Вставить("ПутьДоСертификата", "");
	СтруктураПараметры.Вставить("Логин", "default");
	СтруктураПараметры.Вставить("Пароль", "password");
	СтруктураПараметры.Вставить("ИмяБазы", "db_name");
	//ClickHouseDB, PostgreSQL
	СтруктураПараметры.Вставить("ТипБазы", "ClickHouseDB");
	СтруктураПараметры.Вставить("ИмяТаблицы", "ИмяТаблицы");
	СтруктураПараметры.Вставить("ИмяПользователя", "Фоновый");	
	//	
	СтруктураПараметры.Вставить("ДатаНачала", ДатаДнейНазад(ТекущаяДата, 1));
	СтруктураПараметры.Вставить("ДатаОкончания", КонецДня(ТекущаяДата));
	//
	СтруктураПараметры.Вставить("ЭтоПоЗапросу", Ложь);
	СтруктураПараметры.Вставить("ЭтоТекущаяДата", Ложь);
	СтруктураПараметры.Вставить("ТекстЗапроса", "");
	СтруктураПараметры.Вставить("ИспользоватьПериодВКлюче", Ложь);
	СтруктураПараметры.Вставить("КоличествоДнейНазад", 1);
	//
	СтруктураПараметры.Вставить("КомандыФоновые", Новый ТаблицаЗначений());
	//
	СтруктураПараметры.Вставить("АбсолютныйПутьPython", "C:\Program Files\Python38\python.exe");
КонецФункции
```

## Добавление отчетов на основе СКД

Макеты -> Добавить

Формируем или вставляем наш запрос.

Имя вашего макета для запроса **должно начинается с "Запрос"**<дальше ваше наименование>

### Требования

Добавить в параметры своего отчета

**Всегда использовать Период, как дату, а не стандартный период в параметрах СКД.**

**КоличествоДнейНазад** – за какое количество дней формировать отчет и обновлять записи в базе. По умолчанию = 1

**Начало и окончание дат периода** должны быть обозначены **Дата1 и Дата2.**

Остальные примеры для месяца и дня смотри функцию **ВернутьДату\_Запрос\_НаСервере**

## Добавление обработки в информационную базу

Администрирование -> Дополнительные обработки и отчеты

Добавить из файла.

Для добавленных команд в таблицу команд, будет возможность использовать их как фоновое задание. Отмечаем галочками и выставляем расписание исполнения.

Как только сохраните обработку в таком виде, запустятся столько фоновых здание, сколько отметите галками.

Чтобы запустить вручную каждое, необходимо зайти в Администрирование -> Обслуживание -> Регламентные и фоновые задания.

Общая форма обработки не предусмотрена. Используйте команды и кнопки для взаимодействия по образу и подобию из нашей “боевой” обработки.

Have fun!